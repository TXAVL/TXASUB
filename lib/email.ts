import nodemailer from 'nodemailer'

// Gmail SMTP configuration
const transporter = nodemailer.createTransport({
  service: 'gmail',
  auth: {
    user: process.env.GMAIL_USER,
    pass: process.env.GMAIL_APP_PASSWORD
  }
})

// Debug environment variables
console.log('üîß Email Config Debug:')
console.log('GMAIL_USER:', process.env.GMAIL_USER ? '‚úÖ Set' : '‚ùå Missing')
console.log('GMAIL_APP_PASSWORD:', process.env.GMAIL_APP_PASSWORD ? '‚úÖ Set' : '‚ùå Missing')

export interface EmailNotification {
  to: string
  subject: string
  html: string
  text?: string
}

export interface SubscriptionData {
  id: string
  name: string
  expiry: string
  cost: number
  cycle: string
  autoRenew: boolean
  finalExpiry?: string
}

export interface UserProfile {
  email: string
  name: string
  emailNotifications: {
    enabled: boolean
    expiringSoon: boolean // 30 days
    critical: boolean // 2 days
    weekly: boolean
    monthly: boolean
  }
}

// Email templates
export const emailTemplates = {
  expiringSoon: (subscription: SubscriptionData, daysLeft: number) => ({
    subject: `‚ö†Ô∏è G√≥i "${subscription.name}" s·∫Øp h·∫øt h·∫°n (${daysLeft} ng√†y)`,
    html: `
      <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 650px; margin: 0 auto; background: #ffffff;">
        <!-- Header -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px 20px; text-align: center; border-radius: 12px 12px 0 0;">
          <h1 style="color: white; margin: 0; font-size: 28px; font-weight: 600;">üì± Subscription Manager</h1>
          <p style="color: rgba(255,255,255,0.9); margin: 8px 0 0 0; font-size: 16px;">Qu·∫£n l√Ω g√≥i ƒëƒÉng k√Ω th√¥ng minh</p>
        </div>
        
        <!-- Alert Box -->
        <div style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); border-left: 5px solid #ff8c00; padding: 25px; margin: 0;">
          <div style="display: flex; align-items: flex-start; margin-bottom: 15px;">
            <div style="background: #ff8c00; color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-right: 20px; flex-shrink: 0; line-height: 1;">‚ö†Ô∏è</div>
            <div style="flex: 1;">
              <h2 style="color: #d2691e; margin: 0 0 8px 0; font-size: 24px; font-weight: 600; line-height: 1.2;">G√≥i s·∫Øp h·∫øt h·∫°n</h2>
              <p style="color: #8b4513; margin: 0; font-size: 18px; font-weight: 500; line-height: 1.3;">C√≤n ${daysLeft} ng√†y n·ªØa g√≥i s·∫Ω h·∫øt h·∫°n</p>
            </div>
          </div>
        </div>
        
        <!-- Subscription Info -->
        <div style="background: #f8f9fa; padding: 30px; border-radius: 0 0 12px 12px;">
          <h3 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 20px; font-weight: 600;">üìã Th√¥ng tin g√≥i ƒëƒÉng k√Ω</h3>
          
          <div style="background: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
              <div>
                <label style="display: block; color: #7f8c8d; font-size: 14px; font-weight: 500; margin-bottom: 5px;">T√äN G√ìI</label>
                <p style="margin: 0; color: #2c3e50; font-size: 18px; font-weight: 600;">${subscription.name}</p>
              </div>
              <div>
                <label style="display: block; color: #7f8c8d; font-size: 14px; font-weight: 500; margin-bottom: 5px;">CHI PH√ç</label>
                <p style="margin: 0; color: #27ae60; font-size: 18px; font-weight: 600;">$${subscription.cost}/${subscription.cycle === 'monthly' ? 'th√°ng' : 'nƒÉm'}</p>
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <div>
                <label style="display: block; color: #7f8c8d; font-size: 14px; font-weight: 500; margin-bottom: 5px;">NG√ÄY H·∫æT H·∫†N</label>
                <p style="margin: 0; color: #e74c3c; font-size: 16px; font-weight: 600;">${new Date(subscription.expiry).toLocaleDateString('vi-VN')}</p>
              </div>
              <div>
                <label style="display: block; color: #7f8c8d; font-size: 14px; font-weight: 500; margin-bottom: 5px;">T·ª∞ ƒê·ªòNG GIA H·∫†N</label>
                <p style="margin: 0; color: ${subscription.autoRenew ? '#27ae60' : '#e74c3c'}; font-size: 16px; font-weight: 600;">${subscription.autoRenew ? '‚úÖ C√≥' : '‚ùå Kh√¥ng'}</p>
              </div>
            </div>
          </div>
          
          <!-- Action Button -->
          <div style="text-align: center; margin-top: 25px;">
            <a href="${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3001'}/subscriptions" 
               style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 25px; display: inline-block; font-weight: 600; font-size: 16px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
              üîß Qu·∫£n l√Ω g√≥i ƒëƒÉng k√Ω
            </a>
          </div>
        </div>
        
        <!-- Footer -->
        <div style="background: #2c3e50; color: #bdc3c7; padding: 20px; text-align: center; font-size: 14px; border-radius: 0 0 12px 12px;">
          <p style="margin: 0;">üìß Email t·ª± ƒë·ªông t·ª´ <strong>Subscription Manager</strong></p>
          <p style="margin: 5px 0 0 0;">ƒê·ªÉ t·∫Øt th√¥ng b√°o, vui l√≤ng c·∫≠p nh·∫≠t c√†i ƒë·∫∑t trong profile</p>
        </div>
      </div>
    `
  }),

  critical: (subscription: SubscriptionData, hoursLeft: number) => ({
    subject: `üö® KH·∫®N C·∫§P: G√≥i "${subscription.name}" h·∫øt h·∫°n trong ${hoursLeft} gi·ªù!`,
    html: `
      <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 650px; margin: 0 auto; background: #ffffff;">
        <!-- Header -->
        <div style="background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); padding: 30px 20px; text-align: center; border-radius: 12px 12px 0 0;">
          <h1 style="color: white; margin: 0; font-size: 28px; font-weight: 600;">üö® KH·∫®N C·∫§P</h1>
          <p style="color: rgba(255,255,255,0.9); margin: 8px 0 0 0; font-size: 16px;">G√≥i ƒëƒÉng k√Ω s·∫Øp h·∫øt h·∫°n!</p>
        </div>
        
        <!-- Critical Alert -->
        <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); border-left: 5px solid #dc3545; padding: 25px; margin: 0;">
          <div style="display: flex; align-items: flex-start; margin-bottom: 15px;">
            <div style="background: #dc3545; color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; margin-right: 20px; flex-shrink: 0; line-height: 1; box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);">üö®</div>
            <div style="flex: 1;">
              <h2 style="color: white; margin: 0 0 8px 0; font-size: 26px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.3); line-height: 1.2;">C·∫¢NH B√ÅO KH·∫®N C·∫§P</h2>
              <p style="color: rgba(255,255,255,0.95); margin: 0; font-size: 20px; font-weight: 600; line-height: 1.3;">C√≤n ${hoursLeft} gi·ªù n·ªØa g√≥i s·∫Ω h·∫øt h·∫°n!</p>
            </div>
          </div>
        </div>
        
        <!-- Subscription Info -->
        <div style="background: #f8f9fa; padding: 30px; border-radius: 0 0 12px 12px;">
          <h3 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 20px; font-weight: 600;">üìã Th√¥ng tin g√≥i ƒëƒÉng k√Ω</h3>
          
          <div style="background: white; border-radius: 10px; padding: 25px; box-shadow: 0 4px 20px rgba(220, 53, 69, 0.2); border: 2px solid #ff6b6b;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
              <div>
                <label style="display: block; color: #7f8c8d; font-size: 14px; font-weight: 500; margin-bottom: 5px;">T√äN G√ìI</label>
                <p style="margin: 0; color: #2c3e50; font-size: 20px; font-weight: 700;">${subscription.name}</p>
              </div>
              <div>
                <label style="display: block; color: #7f8c8d; font-size: 14px; font-weight: 500; margin-bottom: 5px;">CHI PH√ç</label>
                <p style="margin: 0; color: #27ae60; font-size: 20px; font-weight: 700;">$${subscription.cost}/${subscription.cycle === 'monthly' ? 'th√°ng' : 'nƒÉm'}</p>
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <div>
                <label style="display: block; color: #7f8c8d; font-size: 14px; font-weight: 500; margin-bottom: 5px;">NG√ÄY H·∫æT H·∫†N</label>
                <p style="margin: 0; color: #dc3545; font-size: 18px; font-weight: 700; text-shadow: 0 1px 2px rgba(220, 53, 69, 0.3);">${new Date(subscription.expiry).toLocaleDateString('vi-VN')}</p>
              </div>
              <div>
                <label style="display: block; color: #7f8c8d; font-size: 14px; font-weight: 500; margin-bottom: 5px;">T·ª∞ ƒê·ªòNG GIA H·∫†N</label>
                <p style="margin: 0; color: ${subscription.autoRenew ? '#27ae60' : '#dc3545'}; font-size: 18px; font-weight: 700;">${subscription.autoRenew ? '‚úÖ C√≥' : '‚ùå Kh√¥ng'}</p>
              </div>
            </div>
          </div>
          
          <!-- Urgent Action Button -->
          <div style="text-align: center; margin-top: 25px;">
            <a href="${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3001'}/subscriptions" 
               style="background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); color: white; padding: 18px 35px; text-decoration: none; border-radius: 30px; display: inline-block; font-weight: 700; font-size: 18px; box-shadow: 0 6px 20px rgba(255, 65, 108, 0.4); text-transform: uppercase; letter-spacing: 1px;">
              üî• GIA H·∫†N NGAY
            </a>
          </div>
          
          <!-- Countdown Timer -->
          <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; margin-top: 20px;">
            <h4 style="margin: 0 0 10px 0; font-size: 16px;">‚è∞ TH·ªúI GIAN C√íN L·∫†I</h4>
            <p style="margin: 0; font-size: 24px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">${hoursLeft} GI·ªú</p>
          </div>
        </div>
        
        <!-- Footer -->
        <div style="background: #2c3e50; color: #bdc3c7; padding: 20px; text-align: center; font-size: 14px; border-radius: 0 0 12px 12px;">
          <p style="margin: 0;">üö® Email kh·∫©n c·∫•p t·ª´ <strong>Subscription Manager</strong></p>
          <p style="margin: 5px 0 0 0;">H√†nh ƒë·ªông ngay ƒë·ªÉ tr√°nh gi√°n ƒëo·∫°n d·ªãch v·ª•!</p>
        </div>
      </div>
    `
  }),

  weekly: (subscriptions: SubscriptionData[]) => ({
    subject: `üìä B√°o c√°o tu·∫ßn - ${subscriptions.length} g√≥i ƒëƒÉng k√Ω`,
    html: `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
          <h2 style="color: #0c5460; margin: 0 0 10px 0;">üìä B√°o c√°o tu·∫ßn</h2>
          <p style="color: #0c5460; margin: 0;">T·ªïng quan v·ªÅ c√°c g√≥i ƒëƒÉng k√Ω c·ªßa b·∫°n.</p>
        </div>
        
        <div style="background: #f8f9fa; border-radius: 8px; padding: 20px;">
          <h3 style="margin: 0 0 15px 0; color: #333;">Th·ªëng k√™</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div style="background: white; padding: 15px; border-radius: 6px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #007bff;">${subscriptions.length}</div>
              <div style="color: #6c757d; font-size: 14px;">T·ªïng s·ªë g√≥i</div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 6px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #28a745;">$${subscriptions.reduce((sum, sub) => sum + sub.cost, 0)}</div>
              <div style="color: #6c757d; font-size: 14px;">T·ªïng chi ph√≠</div>
            </div>
          </div>
        </div>
        
        <div style="margin-top: 20px; text-align: center;">
          <a href="${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3001'}/subscriptions" 
             style="background: #007bff; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
            Xem chi ti·∫øt
          </a>
        </div>
      </div>
    `
  }),

  monthly: (subscriptions: SubscriptionData[]) => ({
    subject: `üìà B√°o c√°o th√°ng - Ph√¢n t√≠ch chi ti·∫øt`,
    html: `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
          <h2 style="color: #155724; margin: 0 0 10px 0;">üìà B√°o c√°o th√°ng</h2>
          <p style="color: #155724; margin: 0;">Ph√¢n t√≠ch chi ti·∫øt v·ªÅ c√°c g√≥i ƒëƒÉng k√Ω c·ªßa b·∫°n.</p>
        </div>
        
        <div style="background: #f8f9fa; border-radius: 8px; padding: 20px;">
          <h3 style="margin: 0 0 15px 0; color: #333;">Th·ªëng k√™ chi ti·∫øt</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div style="background: white; padding: 15px; border-radius: 6px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #007bff;">${subscriptions.length}</div>
              <div style="color: #6c757d; font-size: 14px;">T·ªïng s·ªë g√≥i</div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 6px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #28a745;">$${subscriptions.reduce((sum, sub) => sum + sub.cost, 0)}</div>
              <div style="color: #6c757d; font-size: 14px;">T·ªïng chi ph√≠</div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 6px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${subscriptions.filter(sub => !sub.autoRenew).length}</div>
              <div style="color: #6c757d; font-size: 14px;">C·∫ßn gia h·∫°n th·ªß c√¥ng</div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 6px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">${subscriptions.filter(sub => sub.autoRenew).length}</div>
              <div style="color: #6c757d; font-size: 14px;">T·ª± ƒë·ªông gia h·∫°n</div>
            </div>
          </div>
        </div>
        
        <div style="margin-top: 20px; text-align: center;">
          <a href="${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3001'}/subscriptions" 
             style="background: #007bff; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
            Xem chi ti·∫øt
          </a>
        </div>
      </div>
    `
  })
}

// Send email function
export async function sendEmail(notification: EmailNotification): Promise<boolean> {
  try {
    await transporter.sendMail({
      from: `"Subscription Manager" <${process.env.GMAIL_USER}>`,
      to: notification.to,
      subject: notification.subject,
      html: notification.html,
      text: notification.text
    })
    return true
  } catch (error) {
    console.error('Error sending email:', error)
    return false
  }
}

// Email verification template
export function formatTimeRemaining(minutes: number): string {
  if (minutes >= 60) {
    const hours = Math.floor(minutes / 60)
    const remainingMinutes = minutes % 60
    if (remainingMinutes === 0) {
      return `${hours} gi·ªù`
    } else {
      return `${hours} gi·ªù ${remainingMinutes} ph√∫t`
    }
  } else {
    return `${minutes} ph√∫t`
  }
}

export async function sendVerificationEmail(email: string, token: string): Promise<boolean> {
  const expiryMinutes = parseInt(process.env.VERIFY_TOKEN_EXPIRY || '15')
  const timeRemaining = formatTimeRemaining(expiryMinutes)
  
  const verificationUrl = `${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3001'}/api/auth/verify-email`
  
  const notification: EmailNotification = {
    to: email,
    subject: 'üîê X√°c th·ª±c email - Subscription Manager',
    html: `
      <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 650px; margin: 0 auto; background: #ffffff;">
        <!-- Header -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px 20px; text-align: center; border-radius: 12px 12px 0 0;">
          <h1 style="color: white; margin: 0; font-size: 28px; font-weight: 600;">üîê X√°c th·ª±c email</h1>
          <p style="color: rgba(255,255,255,0.9); margin: 8px 0 0 0; font-size: 16px;">Subscription Manager</p>
        </div>
        
        <!-- Main Content -->
        <div style="background: #f8f9fa; padding: 30px; border-radius: 0 0 12px 12px;">
          <div style="background: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h2 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 24px; font-weight: 600;">Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi Subscription Manager!</h2>
            
            <p style="color: #555; font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;">
              ƒê·ªÉ ho√†n t·∫•t vi·ªác ƒëƒÉng k√Ω t√†i kho·∫£n, vui l√≤ng x√°c th·ª±c email c·ªßa b·∫°n b·∫±ng c√°ch nh·∫•p v√†o n√∫t b√™n d∆∞·ªõi:
            </p>
            
            <!-- Verification Button -->
            <div style="text-align: center; margin: 30px 0;">
              <a href="${verificationUrl}?token=${token}&email=${encodeURIComponent(email)}" 
                 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 25px; display: inline-block; font-weight: 600; font-size: 16px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                ‚úÖ X√°c th·ª±c email ngay
              </a>
            </div>
            
            <!-- Time Remaining -->
            <div style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); border-left: 5px solid #ff8c00; padding: 20px; border-radius: 8px; margin: 20px 0;">
              <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <div style="background: #ff8c00; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 15px; flex-shrink: 0;">‚è∞</div>
                <div>
                  <h3 style="color: #d2691e; margin: 0; font-size: 18px; font-weight: 600;">Th·ªùi gian h·∫øt h·∫°n</h3>
                  <p style="color: #8b4513; margin: 5px 0 0 0; font-size: 16px; font-weight: 500;">Link x√°c th·ª±c s·∫Ω h·∫øt h·∫°n sau: <strong>${timeRemaining}</strong></p>
                </div>
              </div>
            </div>
            
            <!-- Alternative Method -->
            <div style="background: #e8f4fd; border: 1px solid #b8daff; border-radius: 8px; padding: 20px; margin: 20px 0;">
              <h4 style="color: #004085; margin: 0 0 10px 0; font-size: 16px;">üîó Ho·∫∑c sao ch√©p link n√†y:</h4>
              <p style="color: #004085; margin: 0; font-size: 14px; word-break: break-all; background: white; padding: 10px; border-radius: 4px; border: 1px solid #dee2e6;">
                ${verificationUrl}?token=${token}&email=${encodeURIComponent(email)}
              </p>
            </div>
            
            <!-- Security Note -->
            <div style="background: #f8f9fa; border-left: 4px solid #6c757d; padding: 15px; border-radius: 4px; margin: 20px 0;">
              <p style="color: #6c757d; margin: 0; font-size: 14px;">
                <strong>üîí L∆∞u √Ω b·∫£o m·∫≠t:</strong> N·∫øu b·∫°n kh√¥ng y√™u c·∫ßu x√°c th·ª±c email n√†y, vui l√≤ng b·ªè qua email n√†y. 
                T√†i kho·∫£n c·ªßa b·∫°n s·∫Ω kh√¥ng ƒë∆∞·ª£c t·∫°o cho ƒë·∫øn khi email ƒë∆∞·ª£c x√°c th·ª±c.
              </p>
            </div>
          </div>
        </div>
        
        <!-- Footer -->
        <div style="background: #2c3e50; color: #bdc3c7; padding: 20px; text-align: center; font-size: 14px; border-radius: 0 0 12px 12px;">
          <p style="margin: 0;">üìß Email t·ª´ <strong>Subscription Manager</strong></p>
          <p style="margin: 5px 0 0 0;">N·∫øu b·∫°n g·∫∑p v·∫•n ƒë·ªÅ, vui l√≤ng li√™n h·ªá h·ªó tr·ª£</p>
        </div>
      </div>
    `
  }
  
  return await sendEmail(notification)
}

// Check if user wants to receive notifications
export function shouldSendNotification(user: UserProfile, type: 'expiringSoon' | 'critical' | 'weekly' | 'monthly'): boolean {
  if (!user.emailNotifications.enabled) return false
  
  switch (type) {
    case 'expiringSoon':
      return user.emailNotifications.expiringSoon
    case 'critical':
      return user.emailNotifications.critical
    case 'weekly':
      return user.emailNotifications.weekly
    case 'monthly':
      return user.emailNotifications.monthly
    default:
      return false
  }
}